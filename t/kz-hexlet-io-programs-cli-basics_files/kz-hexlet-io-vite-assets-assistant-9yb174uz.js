import{r as a,j as r}from"./index-f3ZQ7e7G.js";import{c as g,u as v}from"./ThemeProvider-BCC4u8C0.js";import{M as Ee}from"./MarkdownViewer-5YxTT1iA.js";import{i as Oe}from"./i18next-CkWrbSxs.js";import{u as z}from"./useTranslation-B9l1dJiu.js";import{P as R}from"./index-BfM5NbKg.js";import{u as _e}from"./useIsomorphicEffect-BJ0a0jR9.js";import{C as Ie}from"./Col-C9Vshd83.js";import{B as Be}from"./Button-z8jYjS-A.js";import{u as De,E as Le,F as He}from"./errorboundary-3ypQP8Vi.js";import{a as Ge}from"./routes-DDr9WLp9.js";import{a as ne}from"./index-Bpy9671J.js";import{d as We}from"./debounce-CLTjDgnO.js";import{R as Ue}from"./client-BCvWFak8.js";import{u as Je}from"./querySelectorAll-Bi51WDZP.js";import{T as Qe,g as ze,t as Ke,A as Ve,M as Xe,B as Ye,F as Ze,a as qe,b as Pe}from"./AbstractModalHeader-DMqN849K.js";import{E as ae,a as et,b as tt}from"./Transition-V9ecCpmH.js";import{d as st}from"./divWithClassName-DfDkDzue.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-6EyIOnmV.js";import"./index-BFnd-0Sq.js";import"./i18nInstance-DBIXdvxg.js";import"./Button-BwLfgPv6.js";import"./index-OAUcaBCa.js";import"./useEventCallback-B1KjAgOW.js";import"./objectWithoutPropertiesLoose-Dsqj8S3w.js";function Tt(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}function nt(t,e){return a.Children.toArray(t).some(s=>a.isValidElement(s)&&s.type===e)}const ot={type:R.string,tooltip:R.bool,as:R.elementType},H=a.forwardRef(({as:t="div",className:e,type:s="valid",tooltip:n=!1,...i},o)=>r.jsx(t,{...i,ref:o,className:g(e,"".concat(s,"-").concat(n?"tooltip":"feedback"))}));H.displayName="Feedback";H.propTypes=ot;const k=a.createContext({}),K=a.forwardRef(({id:t,bsPrefix:e,className:s,type:n="checkbox",isValid:i=!1,isInvalid:o=!1,as:u="input",...c},l)=>{const{controlId:d}=a.useContext(k);return e=v(e,"form-check-input"),r.jsx(u,{...c,ref:l,type:n,id:t||d,className:g(s,e,i&&"is-valid",o&&"is-invalid")})});K.displayName="FormCheckInput";const D=a.forwardRef(({bsPrefix:t,className:e,htmlFor:s,...n},i)=>{const{controlId:o}=a.useContext(k);return t=v(t,"form-check-label"),r.jsx("label",{...n,ref:i,htmlFor:s||o,className:g(e,t)})});D.displayName="FormCheckLabel";const ce=a.forwardRef(({id:t,bsPrefix:e,bsSwitchPrefix:s,inline:n=!1,reverse:i=!1,disabled:o=!1,isValid:u=!1,isInvalid:c=!1,feedbackTooltip:l=!1,feedback:d,feedbackType:f,className:S,style:h,title:C="",type:p="checkbox",label:j,children:y,as:b="input",...N},w)=>{e=v(e,"form-check"),s=v(s,"form-switch");const{controlId:T}=a.useContext(k),M=a.useMemo(()=>({controlId:t||T}),[T,t]),F=!y&&j!=null&&j!==!1||nt(y,D),E=r.jsx(K,{...N,type:p==="switch"?"checkbox":p,ref:w,isValid:u,isInvalid:c,disabled:o,as:b});return r.jsx(k.Provider,{value:M,children:r.jsx("div",{style:h,className:g(S,F&&e,n&&"".concat(e,"-inline"),i&&"".concat(e,"-reverse"),p==="switch"&&s),children:y||r.jsxs(r.Fragment,{children:[E,F&&r.jsx(D,{title:C,children:j}),d&&r.jsx(H,{type:f,tooltip:l,children:d})]})})})});ce.displayName="FormCheck";const L=Object.assign(ce,{Input:K,Label:D}),le=a.forwardRef(({bsPrefix:t,type:e,size:s,htmlSize:n,id:i,className:o,isValid:u=!1,isInvalid:c=!1,plaintext:l,readOnly:d,as:f="input",...S},h)=>{const{controlId:C}=a.useContext(k);return t=v(t,"form-control"),r.jsx(f,{...S,type:e,size:n,ref:h,readOnly:d,id:i||C,className:g(o,l?"".concat(t,"-plaintext"):t,s&&"".concat(t,"-").concat(s),e==="color"&&"".concat(t,"-color"),u&&"is-valid",c&&"is-invalid")})});le.displayName="FormControl";const it=Object.assign(le,{Feedback:H}),de=a.forwardRef(({className:t,bsPrefix:e,as:s="div",...n},i)=>(e=v(e,"form-floating"),r.jsx(s,{ref:i,className:g(t,e),...n})));de.displayName="FormFloating";const V=a.forwardRef(({controlId:t,as:e="div",...s},n)=>{const i=a.useMemo(()=>({controlId:t}),[t]);return r.jsx(k.Provider,{value:i,children:r.jsx(e,{...s,ref:n})})});V.displayName="FormGroup";const ue=a.forwardRef(({as:t="label",bsPrefix:e,column:s=!1,visuallyHidden:n=!1,className:i,htmlFor:o,...u},c)=>{const{controlId:l}=a.useContext(k);e=v(e,"form-label");let d="col-form-label";typeof s=="string"&&(d="".concat(d," ").concat(d,"-").concat(s));const f=g(i,e,n&&"visually-hidden",s&&d);return o=o||l,s?r.jsx(Ie,{ref:c,as:"label",className:f,htmlFor:o,...u}):r.jsx(t,{ref:c,className:f,htmlFor:o,...u})});ue.displayName="FormLabel";const fe=a.forwardRef(({bsPrefix:t,className:e,id:s,...n},i)=>{const{controlId:o}=a.useContext(k);return t=v(t,"form-range"),r.jsx("input",{...n,type:"range",ref:i,className:g(e,t),id:s||o})});fe.displayName="FormRange";const he=a.forwardRef(({bsPrefix:t,size:e,htmlSize:s,className:n,isValid:i=!1,isInvalid:o=!1,id:u,...c},l)=>{const{controlId:d}=a.useContext(k);return t=v(t,"form-select"),r.jsx("select",{...c,size:s,ref:l,className:g(n,t,e&&"".concat(t,"-").concat(e),i&&"is-valid",o&&"is-invalid"),id:u||d})});he.displayName="FormSelect";const me=a.forwardRef(({bsPrefix:t,className:e,as:s="small",muted:n,...i},o)=>(t=v(t,"form-text"),r.jsx(s,{...i,ref:o,className:g(e,t,n&&"text-muted")})));me.displayName="FormText";const pe=a.forwardRef((t,e)=>r.jsx(L,{...t,ref:e,type:"switch"}));pe.displayName="Switch";const rt=Object.assign(pe,{Input:L.Input,Label:L.Label}),ge=a.forwardRef(({bsPrefix:t,className:e,children:s,controlId:n,label:i,...o},u)=>(t=v(t,"form-floating"),r.jsxs(V,{ref:u,className:g(e,t),controlId:n,...o,children:[s,r.jsx("label",{htmlFor:n,children:i})]})));ge.displayName="FloatingLabel";const at={_ref:R.any,validated:R.bool,as:R.elementType},X=a.forwardRef(({className:t,validated:e,as:s="form",...n},i)=>r.jsx(s,{...n,ref:i,className:g(t,e&&"was-validated")}));X.displayName="Form";X.propTypes=at;const oe=Object.assign(X,{Group:V,Control:it,Floating:de,Check:L,Switch:rt,Label:ue,Text:me,Range:fe,Select:he,FloatingLabel:ge}),J=new WeakMap,ie=(t,e)=>{if(!t||!e)return;const s=J.get(e)||new Map;J.set(e,s);let n=s.get(t);return n||(n=e.matchMedia(t),n.refCount=0,s.set(n.media,n)),n};function ct(t,e=typeof window>"u"?void 0:window){const s=ie(t,e),[n,i]=a.useState(()=>s?s.matches:!1);return _e(()=>{let o=ie(t,e);if(!o)return i(!1);let u=J.get(e);const c=()=>{i(o.matches)};return o.refCount++,o.addListener(c),c(),()=>{o.removeListener(c),o.refCount--,o.refCount<=0&&(u==null||u.delete(o.media)),o=void 0}},[t]),n}function lt(t){const e=Object.keys(t);function s(c,l){return c===l?l:c?"".concat(c," and ").concat(l):l}function n(c){return e[Math.min(e.indexOf(c)+1,e.length-1)]}function i(c){const l=n(c);let d=t[l];return typeof d=="number"?d="".concat(d-.2,"px"):d="calc(".concat(d," - 0.2px)"),"(max-width: ".concat(d,")")}function o(c){let l=t[c];return typeof l=="number"&&(l="".concat(l,"px")),"(min-width: ".concat(l,")")}function u(c,l,d){let f;typeof c=="object"?(f=c,d=l,l=!0):(l=l||!0,f={[c]:l});let S=a.useMemo(()=>Object.entries(f).reduce((h,[C,p])=>((p==="up"||p===!0)&&(h=s(h,o(C))),(p==="down"||p===!0)&&(h=s(h,i(C))),h),""),[JSON.stringify(f)]);return ct(S,d)}return u}const dt=lt({xs:0,sm:576,md:768,lg:992,xl:1200,xxl:1400}),be=a.forwardRef(({className:t,bsPrefix:e,as:s="div",...n},i)=>(e=v(e,"offcanvas-body"),r.jsx(s,{ref:i,className:g(t,e),...n})));be.displayName="OffcanvasBody";const ut={[ae]:"show",[tt]:"show"},ye=a.forwardRef(({bsPrefix:t,className:e,children:s,in:n=!1,mountOnEnter:i=!1,unmountOnExit:o=!1,appear:u=!1,...c},l)=>(t=v(t,"offcanvas"),r.jsx(Qe,{ref:l,addEndListener:Ke,in:n,mountOnEnter:i,unmountOnExit:o,appear:u,...c,childRef:ze(s),children:(d,f)=>a.cloneElement(s,{...f,className:g(e,s.props.className,(d===ae||d===et)&&"".concat(t,"-toggling"),ut[d])})})));ye.displayName="OffcanvasToggling";const ve=a.forwardRef(({bsPrefix:t,className:e,closeLabel:s="Close",closeButton:n=!1,...i},o)=>(t=v(t,"offcanvas-header"),r.jsx(Ve,{ref:o,...i,className:g(e,t),closeLabel:s,closeButton:n})));ve.displayName="OffcanvasHeader";const ft=st("h5"),Se=a.forwardRef(({className:t,bsPrefix:e,as:s=ft,...n},i)=>(e=v(e,"offcanvas-title"),r.jsx(s,{ref:i,className:g(t,e),...n})));Se.displayName="OffcanvasTitle";function ht(t){return r.jsx(ye,{...t})}function mt(t){return r.jsx(Ze,{...t})}const we=a.forwardRef(({bsPrefix:t,className:e,children:s,"aria-labelledby":n,placement:i="start",responsive:o,show:u=!1,backdrop:c=!0,keyboard:l=!0,scroll:d=!1,onEscapeKeyDown:f,onShow:S,onHide:h,container:C,autoFocus:p=!0,enforceFocus:j=!0,restoreFocus:y=!0,restoreFocusOptions:b,onEntered:N,onExit:w,onExiting:T,onEnter:M,onEntering:F,onExited:E,backdropClassName:q,manager:P,renderStaticNode:Ce=!1,...ke},Ne)=>{const G=a.useRef();t=v(t,"offcanvas");const[ee,Re]=a.useState(!1),W=Je(h),te=dt(o||"xs","up");a.useEffect(()=>{Re(o?u&&!te:u)},[u,o,te]);const $e=a.useMemo(()=>({onHide:W}),[W]);function Ae(){return P||(d?(G.current||(G.current=new qe({handleContainerOverflow:!1})),G.current):Pe())}const Te=(x,...U)=>{x&&(x.style.visibility="visible"),M==null||M(x,...U)},Me=(x,...U)=>{x&&(x.style.visibility=""),E==null||E(...U)},Fe=a.useCallback(x=>r.jsx("div",{...x,className:g("".concat(t,"-backdrop"),q)}),[q,t]),se=x=>r.jsx("div",{...x,...ke,className:g(e,o?"".concat(t,"-").concat(o):t,"".concat(t,"-").concat(i)),"aria-labelledby":n,children:s});return r.jsxs(r.Fragment,{children:[!ee&&(o||Ce)&&se({}),r.jsx(Xe.Provider,{value:$e,children:r.jsx(Ye,{show:ee,ref:Ne,backdrop:c,container:C,keyboard:l,autoFocus:p,enforceFocus:j&&!d,restoreFocus:y,restoreFocusOptions:b,onEscapeKeyDown:f,onShow:S,onHide:W,onEnter:Te,onEntering:F,onEntered:N,onExit:w,onExiting:T,onExited:Me,manager:Ae(),transition:ht,backdropTransition:mt,renderBackdrop:Fe,renderDialog:se})})]})});we.displayName="Offcanvas";const O=Object.assign(we,{Body:be,Header:ve,Title:Se}),je=a.forwardRef(({bsPrefix:t,variant:e,animation:s="border",size:n,as:i="div",className:o,...u},c)=>{t=v(t,"spinner");const l="".concat(t,"-").concat(s);return r.jsx(i,{ref:c,...u,className:g(o,l,n&&"".concat(l,"-").concat(n),e&&"text-".concat(e))})});je.displayName="Spinner";function _({memberRole:t,body:e}){const s=g("hexlet-content mt-3",{"text-end bg-body-secondary ms-5 p-3 rounded":t==="user"});return r.jsx("div",{className:s,children:r.jsx(Ee,{children:e||""})})}function pt({assistantThread:t,previousMessages:e,focusesCount:s,streamData:n}){const{t:i}=z(),o=i("assistant.disabled");if(!t)return r.jsx("div",{className:"mb-4",children:r.jsx(_,{memberRole:"assistant",body:o})});const{input:u,status:c,messages:l,submitMessage:d,handleInputChange:f}=n,S=a.useRef(null);return a.useEffect(()=>{var h;(h=S.current)==null||h.focus()},[s]),r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"mb-3",children:[r.jsx(_,{memberRole:"assistant",body:i("assistant.greeting")}),e.map(h=>r.jsx(_,{memberRole:h.role,body:h.body},h.id)),l.map(h=>r.jsx(_,{memberRole:h.role,body:h.body},h.id))]}),r.jsxs(oe,{onSubmit:d,children:[r.jsx(oe.Control,{ref:S,disabled:c==="in_progress",as:"textarea",rows:5,value:u,onChange:f}),r.jsxs("div",{className:"d-flex justify-content-end pt-3",children:[Oe.language==="ru"&&r.jsx("a",{className:"btn btn-outline-primary me-2",target:"_blank",rel:"noreferrer",href:i("common.telegram_help_bot_url"),children:i("assistant.human")}),r.jsxs(Be,{disabled:c!=="awaiting_message",type:"submit",children:[c==="in_progress"&&r.jsx(je,{className:"me-2",as:"span",animation:"grow",size:"sm",role:"status","aria-hidden":"true"}),i("assistant.send")]})]})]})]})}var B={logger:typeof console<"u"?console:void 0,WebSocket:typeof WebSocket<"u"?WebSocket:void 0},m={log(...t){this.enabled&&(t.push(Date.now()),B.logger.log("[ActionCable]",...t))}};const A=()=>new Date().getTime(),I=t=>(A()-t)/1e3;class Y{constructor(e){this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=e,this.reconnectAttempts=0}start(){this.isRunning()||(this.startedAt=A(),delete this.stoppedAt,this.startPolling(),addEventListener("visibilitychange",this.visibilityDidChange),m.log("ConnectionMonitor started. stale threshold = ".concat(this.constructor.staleThreshold," s")))}stop(){this.isRunning()&&(this.stoppedAt=A(),this.stopPolling(),removeEventListener("visibilitychange",this.visibilityDidChange),m.log("ConnectionMonitor stopped"))}isRunning(){return this.startedAt&&!this.stoppedAt}recordMessage(){this.pingedAt=A()}recordConnect(){this.reconnectAttempts=0,delete this.disconnectedAt,m.log("ConnectionMonitor recorded connect")}recordDisconnect(){this.disconnectedAt=A(),m.log("ConnectionMonitor recorded disconnect")}startPolling(){this.stopPolling(),this.poll()}stopPolling(){clearTimeout(this.pollTimeout)}poll(){this.pollTimeout=setTimeout(()=>{this.reconnectIfStale(),this.poll()},this.getPollInterval())}getPollInterval(){const{staleThreshold:e,reconnectionBackoffRate:s}=this.constructor,n=Math.pow(1+s,Math.min(this.reconnectAttempts,10)),o=(this.reconnectAttempts===0?1:s)*Math.random();return e*1e3*n*(1+o)}reconnectIfStale(){this.connectionIsStale()&&(m.log("ConnectionMonitor detected stale connection. reconnectAttempts = ".concat(this.reconnectAttempts,", time stale = ").concat(I(this.refreshedAt)," s, stale threshold = ").concat(this.constructor.staleThreshold," s")),this.reconnectAttempts++,this.disconnectedRecently()?m.log("ConnectionMonitor skipping reopening recent disconnect. time disconnected = ".concat(I(this.disconnectedAt)," s")):(m.log("ConnectionMonitor reopening"),this.connection.reopen()))}get refreshedAt(){return this.pingedAt?this.pingedAt:this.startedAt}connectionIsStale(){return I(this.refreshedAt)>this.constructor.staleThreshold}disconnectedRecently(){return this.disconnectedAt&&I(this.disconnectedAt)<this.constructor.staleThreshold}visibilityDidChange(){document.visibilityState==="visible"&&setTimeout(()=>{(this.connectionIsStale()||!this.connection.isOpen())&&(m.log("ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = ".concat(document.visibilityState)),this.connection.reopen())},200)}}Y.staleThreshold=6;Y.reconnectionBackoffRate=.15;var xe={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]};const{message_types:$,protocols:Q}=xe,gt=Q.slice(0,Q.length-1),re=[].indexOf;class Z{constructor(e){this.open=this.open.bind(this),this.consumer=e,this.subscriptions=this.consumer.subscriptions,this.monitor=new Y(this),this.disconnected=!0}send(e){return this.isOpen()?(this.webSocket.send(JSON.stringify(e)),!0):!1}open(){if(this.isActive())return m.log("Attempted to open WebSocket, but existing socket is ".concat(this.getState())),!1;{const e=[...Q,...this.consumer.subprotocols||[]];return m.log("Opening WebSocket, current state is ".concat(this.getState(),", subprotocols: ").concat(e)),this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new B.WebSocket(this.consumer.url,e),this.installEventHandlers(),this.monitor.start(),!0}}close({allowReconnect:e}={allowReconnect:!0}){if(e||this.monitor.stop(),this.isOpen())return this.webSocket.close()}reopen(){if(m.log("Reopening WebSocket, current state is ".concat(this.getState())),this.isActive())try{return this.close()}catch(e){m.log("Failed to reopen WebSocket",e)}finally{m.log("Reopening WebSocket in ".concat(this.constructor.reopenDelay,"ms")),setTimeout(this.open,this.constructor.reopenDelay)}else return this.open()}getProtocol(){if(this.webSocket)return this.webSocket.protocol}isOpen(){return this.isState("open")}isActive(){return this.isState("open","connecting")}triedToReconnect(){return this.monitor.reconnectAttempts>0}isProtocolSupported(){return re.call(gt,this.getProtocol())>=0}isState(...e){return re.call(e,this.getState())>=0}getState(){if(this.webSocket){for(let e in B.WebSocket)if(B.WebSocket[e]===this.webSocket.readyState)return e.toLowerCase()}return null}installEventHandlers(){for(let e in this.events){const s=this.events[e].bind(this);this.webSocket["on".concat(e)]=s}}uninstallEventHandlers(){for(let e in this.events)this.webSocket["on".concat(e)]=function(){}}}Z.reopenDelay=500;Z.prototype.events={message(t){if(!this.isProtocolSupported())return;const{identifier:e,message:s,reason:n,reconnect:i,type:o}=JSON.parse(t.data);switch(this.monitor.recordMessage(),o){case $.welcome:return this.triedToReconnect()&&(this.reconnectAttempted=!0),this.monitor.recordConnect(),this.subscriptions.reload();case $.disconnect:return m.log("Disconnecting. Reason: ".concat(n)),this.close({allowReconnect:i});case $.ping:return null;case $.confirmation:return this.subscriptions.confirmSubscription(e),this.reconnectAttempted?(this.reconnectAttempted=!1,this.subscriptions.notify(e,"connected",{reconnected:!0})):this.subscriptions.notify(e,"connected",{reconnected:!1});case $.rejection:return this.subscriptions.reject(e);default:return this.subscriptions.notify(e,"received",s)}},open(){if(m.log("WebSocket onopen event, using '".concat(this.getProtocol(),"' subprotocol")),this.disconnected=!1,!this.isProtocolSupported())return m.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close(t){if(m.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error(){m.log("WebSocket onerror event")}};const bt=function(t,e){if(e!=null)for(let s in e){const n=e[s];t[s]=n}return t};class yt{constructor(e,s={},n){this.consumer=e,this.identifier=JSON.stringify(s),bt(this,n)}perform(e,s={}){return s.action=e,this.send(s)}send(e){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(e)})}unsubscribe(){return this.consumer.subscriptions.remove(this)}}class vt{constructor(e){this.subscriptions=e,this.pendingSubscriptions=[]}guarantee(e){this.pendingSubscriptions.indexOf(e)==-1?(m.log("SubscriptionGuarantor guaranteeing ".concat(e.identifier)),this.pendingSubscriptions.push(e)):m.log("SubscriptionGuarantor already guaranteeing ".concat(e.identifier)),this.startGuaranteeing()}forget(e){m.log("SubscriptionGuarantor forgetting ".concat(e.identifier)),this.pendingSubscriptions=this.pendingSubscriptions.filter(s=>s!==e)}startGuaranteeing(){this.stopGuaranteeing(),this.retrySubscribing()}stopGuaranteeing(){clearTimeout(this.retryTimeout)}retrySubscribing(){this.retryTimeout=setTimeout(()=>{this.subscriptions&&typeof this.subscriptions.subscribe=="function"&&this.pendingSubscriptions.map(e=>{m.log("SubscriptionGuarantor resubscribing ".concat(e.identifier)),this.subscriptions.subscribe(e)})},500)}}class St{constructor(e){this.consumer=e,this.guarantor=new vt(this),this.subscriptions=[]}create(e,s){const n=e,i=typeof n=="object"?n:{channel:n},o=new yt(this.consumer,i,s);return this.add(o)}add(e){return this.subscriptions.push(e),this.consumer.ensureActiveConnection(),this.notify(e,"initialized"),this.subscribe(e),e}remove(e){return this.forget(e),this.findAll(e.identifier).length||this.sendCommand(e,"unsubscribe"),e}reject(e){return this.findAll(e).map(s=>(this.forget(s),this.notify(s,"rejected"),s))}forget(e){return this.guarantor.forget(e),this.subscriptions=this.subscriptions.filter(s=>s!==e),e}findAll(e){return this.subscriptions.filter(s=>s.identifier===e)}reload(){return this.subscriptions.map(e=>this.subscribe(e))}notifyAll(e,...s){return this.subscriptions.map(n=>this.notify(n,e,...s))}notify(e,s,...n){let i;return typeof e=="string"?i=this.findAll(e):i=[e],i.map(o=>typeof o[s]=="function"?o[s](...n):void 0)}subscribe(e){this.sendCommand(e,"subscribe")&&this.guarantor.guarantee(e)}confirmSubscription(e){m.log("Subscription confirmed ".concat(e)),this.findAll(e).map(s=>this.guarantor.forget(s))}sendCommand(e,s){const{identifier:n}=e;return this.consumer.send({command:s,identifier:n})}}class wt{constructor(e){this._url=e,this.subscriptions=new St(this),this.connection=new Z(this),this.subprotocols=[]}get url(){return jt(this._url)}send(e){return this.connection.send(e)}connect(){return this.connection.open()}disconnect(){return this.connection.close({allowReconnect:!1})}ensureActiveConnection(){if(!this.connection.isActive())return this.connection.open()}addSubProtocol(e){this.subprotocols=[...this.subprotocols,e]}}function jt(t){if(typeof t=="function"&&(t=t()),t&&!/^wss?:/i.test(t)){const e=document.createElement("a");return e.href=t,e.href=e.href,e.protocol=e.protocol.replace("http","ws"),e.href}else return t}function xt(t=Ct("url")||xe.default_mount_path){return new wt(t)}function Ct(t){const e=document.head.querySelector("meta[name='action-cable-".concat(t,"']"));if(e)return e.getAttribute("content")}const kt="wss://hexlet.io/cable",Nt=xt(kt);function Rt(t,e){const{enqueueSnackbar:s}=De(),{t:n}=z(),[i,o]=a.useState([]),[u,c]=a.useState(""),[l,d]=a.useState("awaiting_message"),f=a.useRef({}),S=a.useRef(We(p=>{const y=f.current[p].join("");o(b=>b.find(w=>w.id===p)?b.map(w=>w.id===p?{...w,body:y}:w):[...b,{id:p,role:"assistant",body:y}])},50)).current;return a.useEffect(()=>{const p=Nt.subscriptions.create({channel:"AssistantChannel",id:t},{connected(){console.log("connected")},disconnected(){d("awaiting_message"),console.log("disconnected")},rejected(){console.log("rejected")},received(j){const{message_id:y,delta:b,index:N}=j;console.log(b),f.current[y]||(f.current[y]=[]),b[0]==="DONE"?(console.log("ðŸ“¡ Stream finished for message:",y),d("awaiting_message")):f.current[y][N]=b,S(y)}});return()=>{p.unsubscribe(),S.cancel()}},[t]),{messages:i,input:u,handleInputChange:p=>{c(p.target.value)},submitMessage:async p=>{var y;if(p.preventDefault(),!u.trim())return;d("in_progress");const j={id:crypto.randomUUID(),role:"user",body:u};o(b=>[...b,j]),c("");try{await ne.post(Ge(t),{message:u,output:e})}catch(b){if(d("awaiting_message"),ne.isAxiosError(b)){if(((y=b.response)==null?void 0:y.status)===429){const N=n("assistant.disabled_html");o(w=>[...w,{id:crypto.randomUUID(),role:"assistant",body:N}])}s(b.message),console.error(b)}else throw b}},status:l}}function $t(){const t=window.gon.assistant_thread,[e,s]=a.useState(!1),[n,i]=a.useState(0),o=()=>s(!1);a.useEffect(()=>{const d=document.querySelectorAll(".root-assistant-btn");for(const f of d)f.addEventListener("click",()=>{s(!0),i(S=>S+1)})},[]);const{t:u}=z(),c=u("assistant.disabled");let l=null;return t&&(l=Rt(t.id,"")),r.jsxs(O,{placement:"end",className:"bg-body-light border-0",show:e,onHide:o,children:[r.jsx(O.Header,{closeButton:!0,children:r.jsx(O.Title,{as:"div",className:"h4",children:u("assistant.name")})}),r.jsx(O.Body,{className:"my-3",children:r.jsxs(Le,{fallback:r.jsx(He,{}),children:[!t&&r.jsx("div",{className:"mb-4",children:c}),t&&l&&r.jsx(pt,{focusesCount:n,previousMessages:window.gon.assistant_thread_messages,assistantThread:t,streamData:l})]})})]})}function At(t={}){const e=document.getElementById("root-assistant-offcanvas");if(!e)throw new Error("root element is not found");Ue.createRoot(e).render(r.jsx($t,{...t}))}At();export{Tt as __vite_legacy_guard};
